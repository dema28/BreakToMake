name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-24.04  # Используем последнюю доступную версию Ubuntu

    steps:
    # Шаг 1: Проверяем репозиторий
    - name: Checkout code
      uses: actions/checkout@v3

    # Шаг 2: Установка JDK 11
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'adoptium'  # Заменили на adoptium
        java-package: jdk
        check-latest: false
        server-id: github
        server-username: GITHUB_ACTOR
        server-password: GITHUB_TOKEN
        overwrite-settings: true
        job-status: success
        token: ${{ secrets.GITHUB_TOKEN }}

    # Шаг 3: Установка зависимостей
    - name: Install dependencies
      run: |
        # Для Java-проектов, если используется Maven:
        mvn install
        # Для Python-проектов:
        pip install -r requirements.txt

    # Шаг 4: Запуск тестов Java
    - name: Run Java tests
      run: mvn test

    # Шаг 5: Запуск тестов Python
    - name: Run Python tests
      run: |
        python -m unittest discover -s python_tests/tests

    # Шаг 6: Запуск тестов в Postman через Newman
    - name: Run Postman tests with Newman
      run: |
        newman run postman/collections/login_collection.json
        newman run postman/collections/product_collection.json
        newman run postman/collections/home_collection.json

    # Шаг 7: Сохранение отчётов
    - name: Save test reports
      run: |
        mkdir -p reports/java_reports
        mv target/*.xml reports/java_reports/

        mkdir -p reports/python_reports
        mv python_tests/*.xml reports/python_reports/

        mkdir -p reports/postman_reports
        mv postman/tests/*.json reports/postman_reports/
